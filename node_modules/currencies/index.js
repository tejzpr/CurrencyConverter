
const CURRENCIES = {
    USD: { name: 'US Dollar',           symbol: '\u0024',               rate: 1 }
  , AUD: { name: 'Australian Dollar',   symbol: '\u0024',               rate: 0.95 }
  , KRW: { name: 'Korean Won',          symbol: '\u20A9',               rate: 1129.18 }
  , JPY: { name: 'Japanese Yen',        symbol: '\u00A5',               rate: 99.39 }
  , BGN: { name: 'Bulgarian Lev',       symbol: '\u043B\u0042',         rate: 1.49 }
  , CZK: { name: 'Czech Koruna',        symbol: '\u004B\u010D',         rate: 19.77 }
  , DKK: { name: 'Danish Krone',        symbol: '\u006B\u0072',         rate: 5.68 }
  , GBP: { name: 'UK Pound',            symbol: '\u00A3',               rate: 0.65 }
  , HUF: { name: 'Hungarian Forint',    symbol: '\u0046\u0074',         rate: 226.99 }
  , LTL: { name: 'Lithuanian Litas',    symbol: '\u004C\u0074',         rate: 2.63 }
  , LVL: { name: 'Latvian Lat',         symbol: '\u004C\u0073',         rate: 0.53 }
  , PLN: { name: 'Polish Zloty',        symbol: '\u007A\u0142',         rate: 3.13 }
  , RON: { name: 'Romanian New Leu',    symbol: '\u006C\u0065\u0069',   rate: 3.35 }
  , SEK: { name: 'Swedish Krona',       symbol: '\u006B\u0072',         rate: 6.34 }
  , CHF: { name: 'Swiss Franc',         symbol: '\u0043\u0048\u0046',   rate: 0.93 }
  , NOK: { name: 'Norwegian Krone',     symbol: '\u006B\u0072',         rate: 5.7 }
  , HRK: { name: 'Croatian Kruna',      symbol: '\u006B\u006E',         rate: 5.81 }
  , RUB: { name: 'Russian Ruble',       symbol: '\u0440\u0443\u0431',   rate: 30.81 }
  , TRY: { name: 'Turkish Lira',        symbol: '\u20A4',               rate: 1.79 }
  , BRL: { name: 'Brazilian Real',      symbol: '\u0052\u0024',         rate: 1.97 }
  , CAD: { name: 'Canadan Dollar',      symbol: '\u0024',               rate: 1.01 }
  , CNY: { name: 'Chinese Yuan',        symbol: '\u00A5',               rate: 6.2 }
  , HKD: { name: 'Hong Kong Dollar',    symbol: '\u0024',               rate: 7.76 }
  , IDR: { name: 'Indonesian Rupiah',   symbol: '\u0052\u0070',         rate: 9709.48 }
  , ILS: { name: 'Israeli Shekel',      symbol: '\u20AA',               rate: 3.63 }
  , INR: { name: 'Indian Rupee',        symbol: '\u20A8',               rate: 54.52 }
  , MXN: { name: 'Mexican Peso',        symbol: '\u0024',               rate: 12.09 }
  , MYR: { name: 'Malaysian Ringgit',   symbol: '\u0052\u004D',         rate: 3.03 }
  , NZD: { name: 'New Zealand Dollar',  symbol: '\u0024',               rate: 1.15 }
  , PHP: { name: 'Philippine Peso',     symbol: '\u20B1',               rate: 41.03 }
  , SGD: { name: 'Singaporean Dollar',  symbol: '\u0024',               rate: 1.24 }
  , THB: { name: 'Thai Baht',           symbol: '\u0E3F',               rate: 29.03 }
  , ZAR: { name: 'South African Rand',  symbol: '\u0052',               rate: 8.91 }
  , EUR: { name: 'Euro',                symbol: '\u20AC',               rate: 0.76 }
};

module.exports = Currencies;

function Currencies() { };

Currencies.CURRENCIES = CURRENCIES;

Currencies.set = set;

function set(currency, rate) {
  if (typeof currency === 'object') {
    Object.keys(currency).forEach(function(key) {
      set(key, currency[key]);
    });
  } else {
    var uc = currency.toUpperCase();
    if (CURRENCIES[uc]) CURRENCIES[uc].rate = rate;
  };
};

Currencies.get = get;

function get(currency) {
  var result;
  if (currency) {
    result = CURRENCIES[currency.toUpperCase()];
  } else {
    result = CURRENCIES;
  };
  return result;
};

// All things relative to USA
function normalize(rates, USD) {
  var result = { };
  var l = rates.length;
  while (l--) {
    var rate = parseFloat((rates[l].rate / USD).toFixed(2));
    result[rates[l].name] = rate;
  };
  return result;
};

var http = require('http');
var URL  = require('url');

// European Central Bank exchange rates
var ECB  = URL.parse('http://www.ecb.europa.eu/stats/eurofxref/eurofxref-daily.xml');
var RE = /currency=\'(\w{3})\' rate=\'([\d\.?]+)/;

Currencies.fetch = fetch;

function fetch(callback) {
  var request = http.request(ECB, function(response) {
    if (response.statusCode !== 200) {
      return callback(null, null);
    };

    var body = '';
    response.setEncoding('utf8');
    response.on('error', callback);
    response.on('data', function(data) { body += data; });
    response.on('end', function() {
      var rates = [ { name: 'EUR', rate: 1 } ];
      var USD = 1;
      var match;

      while (match = body.match(RE)) {
        var name = match[1];
        var rate = parseFloat(match[2]);
        if (name === 'USD') USD = rate;
        rates.push({ name: name, rate: rate });
        body = body.substring(match.index + match[0].length);
      };

      callback(null, normalize(rates, USD));
    });
  });

  request.on('error', callback);
  request.setTimeout(1000 * 5);
  request.end();
};

Currencies.update = update;

// Fetch new exchange rate data from
// European Central Bank. Normalize
// those rates to the US Dollar, and
// update our CURRENCIES map
function update(callback) {
  Currencies.fetch(function(err, result) {
    if (!err && result) Currencies.set(result);
    if (callback) callback(err, get());
  });
};
